<!DOCTYPE html>
<html lang="en">
	<head>
		<title>WebKenKen</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				color: #000000;
				font-family:Monospace;
				font-size:15px;
				text-align:center;

				background-color: #f0f0f0;
				margin: 0px;
				overflow: hidden;
			}

			table, td{
				border: 1px solid red;
			}

			table{
				margin: 2px auto;
			}

			td{
				width: 1em;
				height: 1em;
			}

		</style>
	</head>
	<body>
		<h1>WebKenKen</h1>
		<input type="button" onclick="solve()" value="Solve"></input>
		<input type="button" onclick="hide()" value="Hide"></input>
		<div id="container"></div>

		<script>
		var table;
		var size = 3;
		var board = new Array(size * size);
		var region = new Array(size * size);
		var memos = new Array(size * size);
		var selectedCell = null;
		var selectedCoords = null;

		function iterateCells(func){
			for(var iy = 0; iy < size; iy++){
				for(var ix = 0; ix < size; ix++){
					func(ix, iy);
				}
			}
		}

		function solve(){
			iterateCells(function(ix, iy){
				var valueDiv = document.getElementById('r' + iy + 'c' + ix);
				valueDiv.innerHTML = board[ix + iy * size];
				valueDiv.style.display = 'block';
			});
		}

		function hide(){
			iterateCells(function(ix, iy){
				var valueDiv = document.getElementById('r' + iy + 'c' + ix);
				valueDiv.style.display = 'none';
			});
		}

		window.onload = function(){
			var container = document.getElementById("container");
			table = document.createElement("table");
			table.border = '1px';
			table.style.borderColor = 'red';
			table.style.borderSpacing = '2px';
			table.style.tableLayout = 'fixed';
			table.style.position = 'relative';
			table.style.width = (size * 5.5 + 0.4) + 'em';
			table.style.height = (size * 5.5 + 0.4) + 'em';
			var latinSquareTries = 0;
			for(var iy = 0; iy < size; iy++){
				for(var tries = 0; tries < 1000; tries++){
					latinSquareTries++;
					if((function(){
						var next = board.slice(0);
						var avail = [];
						for(var i = 0; i < size; i++)
							avail.push(i+1);
						for(var ix = 0; ix < size; ix++){
							var idx = Math.floor((Math.random() * avail.length));
							for(var j = 0; j < iy; j++){
								if(board[ix + j * size] === avail[idx])
									return false;
							}
							next[ix + iy * size] = avail[idx];
							avail.splice(idx, 1);
						}
						board = next;
						return true;
					})())
						break;
				}
			}

			var colors = [
				'#777',
				'#f77',
				'#7f7',
				'#77f',
				'#ff7',
				'#7ff',
				'#f7f',
				'#f00',
				'#0f0',
				'#00f',
			]

			var allTries = 0;

			function paintCells(region){
				for(var y = 0; y < size; y++){
					for(var x = 0; x < size; x++){
						table.children[y].children[x].style.backgroundColor = colors[region[x + y * size] % colors.length];
					}
				}
			}

			function growCells(type, region){
				function growCellSingle(x, y, type, region, cells){
					allTries++;
					if(2 <= cells && Math.random() < 0.5 || 3 <= cells){
						var ret = growCells(type, region);
						if(ret)
							return ret;
						paintCells(region);
					}
					var next = region.slice(0);
					next[x + y * size] = type;
					paintCells(next);
					var deltax = [-1, 0, 1, 0];
					var deltay = [0, -1, 0, 1];
					var avail = [];
					for(var i = 0; i < 4; i++){
						var newx = x + deltax[i];
						var newy = y + deltay[i];
						if(newx < 0 || size <= newx || newy < 0 || size <= newy)
							continue;
						if(region[newx + newy * size])
							continue;
						avail.push([newx, newy]);
					}
					while(avail.length){
						var index = Math.floor(Math.random() * avail.length);
						var newx = avail[index][0];
						var newy = avail[index][1];
						var ret = growCellSingle(newx, newy, type, next, cells + 1);
						if(ret)
							return ret;
						avail.splice(index, 1);
					}
					// At least 2 cells are required
					if(cells < 1)
						return null;
					return growCells(type, next);
				}

				function growCellTry(type, region){

					for(var iy = 0; iy < size; iy++){
						for(var ix = 0; ix < size; ix++){
							if(region[ix + iy * size] === 0){
								return growCellSingle(ix, iy, ++type, region, 0);
							}
						}
					}
					if(iy == size)
						return region;
				}

				var numTries = 1;
				for(var tries = 0; tries < numTries; tries++){
					var ret = growCellTry(type, region);
					if(ret)
						return ret;
				}
				// If all tries fail, return null
				return null;
			}

			for(var iy = 0; iy < size; iy++){
				for(var ix = 0; ix < size; ix++){
					region[ix + iy * size] = 0;
				}
			}

			function selectCell(sel){
				selectedCell = sel;
				iterateCells(function(ix, iy){
					if(table.children[iy].children[ix] === sel){
						table.children[iy].children[ix].style.border = '2px blue solid';
						selectedCoords = [ix, iy];
					}
					else
						table.children[iy].children[ix].style.border = '1px black solid';
				})
			}

			container.appendChild(table);
			for(var iy = 0; iy < size; iy++){
				var row = document.createElement("tr");
				table.appendChild(row);
				for(var ix = 0; ix < size; ix++){
					var cell = document.createElement("td");
					cell.innerHTML = "";
					//cell.style.backgroundColor = colors[region[ix + iy * size] % 4];
					cell.style.width = '5em';
					cell.style.height = '5em';
					cell.style.position = 'absolute';
					cell.style.top = (5.5 * iy + 0.2) + 'em';
					cell.style.left = (5.5 * ix + 0.2) + 'em';
					cell.style.verticalAlign = 'middle';
					cell.onclick = function(){
						selectCell(this);
					}
					row.appendChild(cell);

					var valueDiv = document.createElement("div");
					valueDiv.id = 'r' + iy + 'c' + ix;
					valueDiv.style.fontSize = '30px';
					valueDiv.style.position = 'absolute';
					valueDiv.style.top = '50%';
					valueDiv.style.width = '100%';
					valueDiv.style.textAlign = 'center';
					valueDiv.innerHTML = board[ix + iy * size];
					cell.appendChild(valueDiv);
					var r = valueDiv.getBoundingClientRect();
					valueDiv.style.marginTop = (-r.height / 2) + 'px';
					valueDiv.style.display = 'none';

					var memoElem = document.createElement("div");
					memoElem.id = 'memo_r' + iy + 'c' + ix;
					memoElem.style.fontSize = '15px';
					memoElem.style.position = 'relative';
					memoElem.style.top = '100%';
					memoElem.style.marginTop = '-1em';
					cell.appendChild(memoElem);
				}
			}

			selectCell(null);

			var ret = growCells(0, region);
			if(ret){
				region = ret;
				paintCells(region);
				for(var i = 1; i < 100; i++){
					var count = 0;
					var topLeftCell = null;
					var top, left;
					iterateCells(function(ix, iy){
						if(region[ix + iy * size] === i){
							if(count === 0)
								topLeftCell = table.children[top = iy].children[left = ix];
							count++;
						}
					});
					if(count === 0)
						break;
					var avail = ['*', '+'];
					var index = Math.floor(Math.random() * avail.length);
					var oper = avail[index];
					var product = oper === '+' ? 0 : 1;
					iterateCells(function(ix, iy){
						if(region[ix + iy * size] === i){
							if(oper === '+')
								product += board[ix + iy * size];
							else
								product *= board[ix + iy * size];
						}
					});
					var hint = document.createElement('div');
					hint.innerHTML = product + avail[index];
					hint.style.position = 'absolute';
					hint.style.top = '0px';
					topLeftCell.appendChild(hint);
				}
			}

			var answers = document.createElement('div');
			container.appendChild(answers);
			answers.style.fontSize = '25px';
			answers.style.padding = '10px';
			answers.innerHTML = 'Ans: ';

			function addAnswer(str){
				var a = document.createElement('span');
				answers.appendChild(a);
				a.innerHTML = str;
				a.style.marginRight = '10px';
				a.style.border = '1px solid blue';
				a.style.padding = '5px';
				a.onclick = function(){
					if(selectedCoords){
						var valueDiv = document.getElementById('r' + selectedCoords[1] + 'c' + selectedCoords[0]);
						valueDiv.style.display = 'block';
						valueDiv.innerHTML = this.innerHTML;
					}
				};
			}

			for(var i = 0; i < size; i++){
				addAnswer((i + 1).toString());
			}
			addAnswer('&nbsp;');

			var memoContainer = document.createElement('div');
			container.appendChild(memoContainer);
			memoContainer.style.fontSize = '15px';
			memoContainer.style.padding = '10px';
			memoContainer.innerHTML = 'Memo: ';
			for(var i = 0; i < size; i++){
				var a = document.createElement('span');
				memoContainer.appendChild(a);
				a.innerHTML = (i + 1).toString();
				a.style.marginRight = '10px';
				a.style.border = '1px solid blue';
				a.style.padding = '5px';
				a.onclick = function(){
					if(selectedCoords){
						var memoElem = document.getElementById('memo_r' + selectedCoords[1] + 'c' + selectedCoords[0]);
						memoElem.style.display = 'block';
						var currentSet = memos[selectedCoords[0] + selectedCoords[1] * size] || [];
						var idx = currentSet.indexOf(this.innerHTML);
						if(0 <= idx)
							currentSet.splice(idx, 1);
						else {
							currentSet.push(this.innerHTML);
							currentSet.sort();
						}
						memos[selectedCoords[0] + selectedCoords[1] * size] = currentSet;
						memoElem.innerHTML = '';
						for(var j = 0; j < currentSet.length; j++)
							memoElem.innerHTML += currentSet[j];
					}
				}
			}

			var debugText = document.createElement('div');
			debugText.innerHTML = 'labelTries: ' + allTries.toString() + ', latinSquareTries: ' + latinSquareTries.toString();
			container.appendChild(debugText);
		};

		</script>

	</body>
</html>
